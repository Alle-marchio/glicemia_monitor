<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Paziente {{ patient_name }}</title>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <style>
        body { font-family: sans-serif; background-color: #f4f7f6; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; }
        h1 { color: #007bff; text-align: center; }
        .grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-top: 20px; }
        .card { background-color: white; padding: 20px; border-radius: 8px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
        .card h2 { margin-top: 0; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        .metrics { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; text-align: center; }
        .metric-item strong { display: block; font-size: 2em; color: #28a745; }
        .alert-item { padding: 10px; border-radius: 4px; margin-bottom: 10px; font-size: 0.9em; }
        .severity-critical { background-color: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
        .severity-high { background-color: #fff3cd; color: #856404; border-left: 5px solid #ffc107; }
        .severity-medium { background-color: #cce5ff; color: #004085; border-left: 5px solid #007bff; }
        .severity-low { background-color: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .status-active { color: green; font-weight: bold; }
        .status-error, .status-inactive { color: red; font-weight: bold; }
    </style>
</head>
<body>
    <div class="container">
        <h1>Sistema di Monitoraggio Glicemia IoT - {{ patient_name }}</h1>

        <div class="grid">
            <div class="main-content">
    <div class="card">
        <h2>üìà Glicemia Recente (mg/dL)</h2>
        <canvas id="glucoseChart"></canvas>
    </div>

    <div class="card" style="margin-top: 20px;">
        <h2>üìü Stato Sensore Glicemia</h2>
        <div class="metrics">
            <div class="metric-item">Dato Letto (mg/dL)<br><strong id="sensor-reading" style="color: #007bff;">N/A</strong></div>
            <div class="metric-item">Stato Operativo<br><strong id="sensor-status" style="color: #007bff;">N/A</strong></div>
            <div class="metric-item">Batteria Sensore (%)<br><strong id="sensor-batt-level">N/A</strong></div>
            <div class="metric-item">Trend Glicemico<br><strong id="glucose-trend" style="color: #007bff;">N/A</strong></div>
            <div class="metric-item">Tasso di Variazione<br><strong id="trend-rate" style="color: #007bff;">N/A</strong> mg/dL/min</div>
            <div class="metric-item">Dati Letti<br><strong id="history-count">0</strong></div>
        </div>
    </div>
    <div class="card" style="margin-top: 20px;">
        <h2>‚öôÔ∏è Stato Pompa</h2>
        <div class="metrics">
            <div class="metric-item">Livello Insulina (U)<br><strong id="res-level">N/A</strong></div>
            <div class="metric-item">Batteria Pompa (%)<br><strong id="batt-level">N/A</strong></div>
            <div class="metric-item">Stato Operativo<br><strong id="pump-status" class="status-active">N/A</strong></div>
        </div>
        <p style="margin-top: 20px;">Allarmi Attivi: <strong id="alarms-count">0</strong></p>
    </div>
</div>

            <div class="sidebar">
                <div class="card">
                    <h2>üö® Log Notifiche</h2>
                    <div id="alert-list">
                        <div class="alert-item severity-low">In attesa di dati...</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Configurazione Chart.js
        const ctx = document.getElementById('glucoseChart').getContext('2d');
        const glucoseChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: [],
                datasets: [{
                    label: 'Glicemia (mg/dL)',
                    data: [],
                    borderColor: 'rgb(75, 192, 192)',
                    tension: 0.1,
                    fill: false
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: false,
                        title: { display: true, text: 'Glicemia (mg/dL)' }
                    },
                    x: {
                        title: { display: true, text: 'Ora' }
                    }
                }
            }
        });

function updateDashboard() {
            $.getJSON('/data', function(data) {
                // 1. Aggiorna i dati correnti (Card)
                const current = data.current;

                // --- Aggiornamento Dati Sensore ---
                $('#sensor-reading').text(current.glucose_value || 'N/A');
                $('#sensor-status').text(current.glucose_status || 'N/A');
                $('#sensor-batt-level').text(current.sensor_battery || 'N/A');
                $('#glucose-trend').text(current.glucose_trend || 'N/A');
                $('#trend-rate').text(current.trend_rate !== undefined ? current.trend_rate.toFixed(1) : 'N/A');

                // --- Aggiornamento Dati Pompa ---
                $('#res-level').text(current.insulin_reservoir || 'N/A');
                $('#batt-level').text(current.battery_level || 'N/A');
                $('#pump-status').text(current.pump_status || 'N/A');
                $('#alarms-count').text(current.alarms_count || '0');

                // 2. Aggiorna il Grafico e il conteggio
                const history = data.history;
                glucoseChart.data.labels = history.map(item => item.time);
                glucoseChart.data.datasets[0].data = history.map(item => item.value);
                glucoseChart.update();

                $('#history-count').text(history.length); // Aggiorna il conteggio dei dati letti

                // 3. Aggiorna il Log Alert
                const alertList = $('#alert-list');
                alertList.empty();

                if (data.alerts.length === 0) {
                    alertList.append('<div class="alert-item severity-low">Nessun allarme attivo.</div>');
                } else {
                    data.alerts.forEach(alert => {
                        const severityClass = 'severity-' + alert.severity;
                        const alertHtml = `
                            <div class="alert-item ${severityClass}">
                                <strong>[${alert.time}] ${alert.type} (${alert.severity.toUpperCase()})</strong><br>
                                ${alert.message}
                            </div>
                        `;
                        alertList.append(alertHtml);
                    });
                }
            });
        }

        // Esegue il primo aggiornamento e imposta il polling (ogni 1 secondo)
        $(document).ready(function() {
            updateDashboard();
            setInterval(updateDashboard, 1000);
        });
    </script>
</body>
</html>